<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Tester</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>Upload Tester</h1>
            <nav>
                <a href="/">Home</a>
                <a href="/upload.html">Upload</a>
                <a href="/cgi.html">CGI</a>
            </nav>
        </div>
    </header>
    <main>
        <section class="card">
            <h2>POST multipart/form-data</h2>
            <p class="text-muted">Standard HTML form upload to <code>/uploads</code></p>
            <form id="form-multipart" action="/uploads" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" name="file" required>
                </div>
                <button type="submit">Upload</button>
            </form>
            <div id="result-multipart" class="result" style="display:none"></div>
        </section>

        <section class="card">
            <h2>POST raw/binary</h2>
            <p class="text-muted">Uses Fetch API to POST binary data to <code>/uploads</code></p>
            <div class="form-group">
                <input id="file-post" type="file" />
            </div>
            <button id="btn-post">POST to /uploads</button>
            <div id="result-post" class="result" style="display:none"></div>
        </section>

        <section class="card">
            <h2>PUT raw/binary</h2>
            <p class="text-muted">Uses Fetch API to PUT binary data to <code>/put_test/&lt;filename&gt;</code></p>
            <div class="form-group">
                <input id="file-put" type="file" />
            </div>
            <div class="form-group">
                <input id="put-name" type="text" placeholder="filename (optional)">
            </div>
            <button id="btn-put">PUT to /put_test</button>
            <div id="result-put" class="result" style="display:none"></div>
        </section>

        <section class="card">
            <h2>Manage Files</h2>
            <div class="mb-4">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>/uploads</h3>
                    <button id="refresh-uploads" class="btn" style="padding:0.4rem 0.8rem; font-size:0.9rem;">Refresh</button>
                </div>
                <ul id="list-uploads" class="file-list"></ul>
            </div>
            <div class="mb-4">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h3>/uploads_put</h3>
                    <button id="refresh-uploads-put" class="btn" style="padding:0.4rem 0.8rem; font-size:0.9rem;">Refresh</button>
                </div>
                <ul id="list-uploads-put" class="file-list"></ul>
            </div>
            <div id="result-delete" class="result" style="display:none"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 WebServ. All rights reserved.</p>
    </footer>

    <!-- Image Preview Modal -->
    <div id="preview-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:2rem; border-radius:8px; max-width:90%; max-height:90%; display:flex; flex-direction:column; align-items:center; position:relative;">
            <button id="close-modal" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3 id="modal-filename" style="margin-top:0; margin-bottom:1rem; word-break:break-all;"></h3>
            <div id="modal-content" style="flex:1; overflow:auto; margin-bottom:1rem; display:flex; justify-content:center; align-items:center; width:100%;">
                <!-- content injected here -->
            </div>
            <div style="display:flex; gap:1rem;">
                <a id="modal-download" href="#" target="_blank" class="btn" style="text-decoration:none; background:#3b82f6;">Download/Open Original</a>
                <button id="modal-delete" class="btn" style="background-color:#ef4444;">Delete Image</button>
            </div>
        </div>
    </div>

    <script>
    // helper to POST/PUT binary body
    async function sendBinary(method, url, file) {
        const res = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/octet-stream', 'X-Filename': file.name },
            body: file
        });
        const text = await res.text();
        return { status: res.status, text };
    }

    function showResult(el, text) {
        el.textContent = text;
        el.style.display = 'block';
    }

    // POST multipart result handler (server ignores multipart but should still accept body)
    document.getElementById('form-multipart').addEventListener('submit', function(e) {
        const el = document.getElementById('result-multipart');
        showResult(el, 'Uploading...');
        // Let the browser submit; response will render as a new page. Also mirror via fetch to show status inline.
        e.preventDefault();
        const form = e.target;
        fetch(form.action, { method: 'POST', body: new FormData(form) })
            .then(async (r) => ({ status: r.status, text: await r.text() }))
            .then(({ status, text }) => { showResult(el, 'Status ' + status + '\n' + text); })
            .catch(err => { showResult(el, 'Error: ' + err); });
    });

    document.getElementById('btn-post').addEventListener('click', async () => {
        const input = document.getElementById('file-post');
        const resEl = document.getElementById('result-post');
        if (!input.files || !input.files[0]) { showResult(resEl, 'Pick a file first.'); return; }
        showResult(resEl, 'Uploading...');
        try {
            const { status, text } = await sendBinary('POST', '/uploads', input.files[0]);
            showResult(resEl, 'Status ' + status + '\n' + text);
        } catch (e) {
            showResult(resEl, 'Error: ' + e);
        }
    });

    document.getElementById('btn-put').addEventListener('click', async () => {
        const input = document.getElementById('file-put');
        const nameInput = document.getElementById('put-name');
        const resEl = document.getElementById('result-put');
        if (!input.files || !input.files[0]) { showResult(resEl, 'Pick a file first.'); return; }
        const name = nameInput.value.trim() || encodeURIComponent(input.files[0].name);
        const url = '/put_test/' + name;
        showResult(resEl, 'Uploading...');
        try {
            const { status, text } = await sendBinary('PUT', url, input.files[0]);
            showResult(resEl, 'Status ' + status + '\n' + text);
        } catch (e) {
            showResult(resEl, 'Error: ' + e);
        }
    });

    // ---- Directory listing + DELETE helpers ----
    function joinPath(base, rel) {
        if (base.endsWith('/')) base = base.slice(0, -1);
        return base + '/' + rel.replace(/^\//, '');
    }

    async function fetchDirectoryEntries(path) {
        // Expecting autoindex HTML; parse anchor tags
        try {
            async function parseListing(resp, usedPath) {
                if (!resp.ok) {
                    const dbg = document.getElementById('result-delete');
                    if (dbg) showResult(dbg, 'List ' + usedPath + ' -> Status ' + resp.status);
                    return [];
                }
                const html = await resp.text();
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const list = doc.querySelector('ul') || doc.body;
                const anchors = Array.from(list.querySelectorAll('a'));
                const entries = [];
                for (const a of anchors) {
                    const text = (a.textContent || '').trim();
                    const href = (a.getAttribute('href') || '').trim();
                    if (!href || text.toLowerCase().includes('parent')) continue;
                    const absoluteUrl = (href.startsWith('http') || href.startsWith('/')) ? href : joinPath(usedPath, href);
                    try {
                        const u = new URL(absoluteUrl, window.location.origin);
                        if (!u.pathname.startsWith(usedPath)) continue;
                    } catch (_) {}
                    entries.push({ name: text || href, url: absoluteUrl });
                }
                return entries;
            }

            // Try with given path first
            const res = await fetch(path, { method: 'GET' });
            let entries = await parseListing(res, path);
            if (entries.length === 0) {
                // Fallback: toggle trailing slash
                const altPath = path.endsWith('/') ? path.slice(0, -1) : (path + '/');
                const res2 = await fetch(altPath, { method: 'GET' });
                const altEntries = await parseListing(res2, altPath);
                if (altEntries.length > 0) entries = altEntries;
            }
            return entries;
        } catch (_) {
            return [];
        }
    }

    async function handleDelete(url, liEl, resultEl) {
        if (!confirm('Delete ' + url + ' ?')) return;
        showResult(resultEl, 'Deleting ' + url + '...');
        try {
            const res = await fetch(url, { method: 'DELETE' });
            const body = await res.text();
            if (res.ok) {
                if (liEl && liEl.parentNode) liEl.parentNode.removeChild(liEl);
                showResult(resultEl, 'Deleted. Status ' + res.status);
            } else {
                showResult(resultEl, 'Failed (Status ' + res.status + '): ' + body);
            }
        } catch (e) {
            showResult(resultEl, 'Error: ' + e);
        }
    }

    // Modal logic
    const modal = document.getElementById('preview-modal');
    const modalContent = document.getElementById('modal-content');
    const modalFilename = document.getElementById('modal-filename');
    const modalDelete = document.getElementById('modal-delete');
    const modalDownload = document.getElementById('modal-download');
    
    function closePreview() {
        modal.style.display = 'none';
        modalContent.innerHTML = '';
    }

    document.getElementById('close-modal').addEventListener('click', closePreview);
    
    // Close on click outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closePreview();
    });

    function openPreview(item, liEl) {
        modalFilename.textContent = item.name;
        modalDownload.href = item.url;
        modalContent.innerHTML = '';
        
        // Simple heuristic for images
        const lower = item.name.toLowerCase();
        if (lower.endsWith('.png') || lower.endsWith('.jpg') || lower.endsWith('.jpeg') || lower.endsWith('.gif') || lower.endsWith('.webp') || lower.endsWith('.bmp') || lower.endsWith('.ico')) {
            const img = document.createElement('img');
            img.src = item.url;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '60vh'; 
            img.style.objectFit = 'contain';
            modalContent.appendChild(img);
        } else {
            const div = document.createElement('div');
            div.textContent = 'Preview not available for this file type.';
            div.style.padding = '2rem';
            div.style.color = '#64748b';
            modalContent.appendChild(div);
        }

        // Setup delete button in modal
        // We clone it to remove old event listeners
        const newBtn = modalDelete.cloneNode(true);
        modalDelete.parentNode.replaceChild(newBtn, modalDelete);
        
        newBtn.addEventListener('click', async () => {
             // Pass null for liEl because handleDelete prompts for confirmation, and if we're in modal we might want a different flow?
             // Actually, let's reuse handleDelete but we need to handle the confirmation there.
             // Also handleDelete expects resultEl.
             await handleDelete(item.url, liEl, document.getElementById('result-delete'));
             closePreview();
        });

        modal.style.display = 'flex';
    }

    async function renderDirectory(path, listId) {
        const list = document.getElementById(listId);
        const resultEl = document.getElementById('result-delete');
        list.innerHTML = '';
        const items = await fetchDirectoryEntries(path);
        if (!items.length) {
            const li = document.createElement('li');
            li.textContent = '(no files or autoindex disabled)';
            li.style.color = '#64748b';
            li.style.border = 'none';
            list.appendChild(li);
            return;
        }
        for (const item of items) {
            const li = document.createElement('li');
            const nameSpan = document.createElement('span');
            nameSpan.textContent = item.name;
            
            const actions = document.createElement('div');
            
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = 'Open';
            link.style.marginRight = '1rem';
            link.style.fontSize = '0.9rem';
            link.onclick = (e) => {
                e.preventDefault();
                openPreview(item, li);
            };
            
            const btn = document.createElement('button');
            btn.textContent = 'Delete';
            btn.className = 'btn';
            btn.style.backgroundColor = '#ef4444';
            btn.style.padding = '0.3rem 0.8rem';
            btn.style.fontSize = '0.8rem';
            btn.addEventListener('click', () => handleDelete(item.url, li, resultEl));
            
            actions.appendChild(link);
            actions.appendChild(btn);
            
            li.appendChild(nameSpan);
            li.appendChild(actions);
            list.appendChild(li);
        }
    }

    // Wire up refresh buttons and initial load
    document.getElementById('refresh-uploads').addEventListener('click', () => renderDirectory('/uploads/', 'list-uploads'));
    document.getElementById('refresh-uploads-put').addEventListener('click', () => renderDirectory('/uploads_put/', 'list-uploads-put'));
    window.addEventListener('DOMContentLoaded', () => {
        renderDirectory('/uploads/', 'list-uploads');
        renderDirectory('/uploads_put/', 'list-uploads-put');
    });
    </script>
</body>
</html>
